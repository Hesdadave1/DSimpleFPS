using BepInEx;
using UnityEngine;
using System;

[BepInPlugin("com.david.vrfps.final", "DavidStableVRFPS", "1.6.0")]
public class DSimpleFPS : BaseUnityPlugin
{
    private TextMesh _infoMesh;
    private GameObject _infoObj;
    private float _deltaTime;

    void Update()
    {
        _deltaTime += (Time.unscaledDeltaTime - _deltaTime) * 0.1f;

        // Try to find the VR Camera (your head)
        if (_infoObj == null && Camera.main != null)
        {
            CreateVRDisplay();
        }

        if (_infoMesh != null)
        {
            float fps = 1.0f / _deltaTime;
            float ramUsed = GC.GetTotalMemory(false) / (1024f * 1024f);
            
            _infoMesh.text = $"FPS: {Mathf.RoundToInt(fps)}\nRAM: {ramUsed:F1}MB";
            
            // Keeps the text facing you perfectly
            _infoObj.transform.LookAt(Camera.main.transform);
            _infoObj.transform.Rotate(0, 180, 0); 
        }
    }

    void CreateVRDisplay()
    {
        _infoObj = new GameObject("DavidFPS_VR_Text");
        _infoMesh = _infoObj.AddComponent<TextMesh>();

        // Attach it to your head so it follows you
        _infoObj.transform.SetParent(Camera.main.transform);
        
        // Position: 0.7 meters in front, slightly up and to the left
        _infoObj.transform.localPosition = new Vector3(-0.3f, 0.2f, 0.7f);
        
        // Make it small enough for VR
        _infoObj.transform.localScale = new Vector3(0.003f, 0.003f, 0.003f);

        _infoMesh.fontSize = 80; // High quality text
        _infoMesh.color = Color.green; // Green is very easy to spot in Gorilla Tag
        _infoMesh.alignment = TextAlignment.Left;
        _infoMesh.anchor = TextAnchor.UpperLeft;

        // Make sure it draws on top of trees/walls
        _infoObj.GetComponent<MeshRenderer>().material.renderQueue = 4000;
        
        Logger.LogInfo("VR Display Created Successfully!");
    }
}
